## User - Article & Comment

- User 클래스 가져오는법

  - `settings.AUTH_USER_MODEL`

    - return str (string )형태로 리턴됨

    - models.py에서 모델 정의할 때만 사용

      ```python
      from django.conf import settings
      settings.AUTH_USER_MODEL
      ```

      

  - `get_user_model()`

    - return class 형태로 리턴됨

    - models.py 제외한 모든곳에서 사용

      ```python
      from django.contrib.auth import get_user_model
      get_user_model()
      ```

- django 호출순서
  - app install > model
  - settings.py 파일에 INSTALLED_APPS=[] 정의된 순서대로 호출됨

#### User - Article

- articels > models.py :모델수정

  ```python
  from django.conf import settings
  
  class Article(models.Model):
      ...
      user = models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE)
  
  ```

  ```bash
  #/05_django/04_django_form (master)
  $ source ~/venv/Scripts/activate
  $ python manage.py makemigrations
  You are trying to add a non-nullable field 'user' to article without a default; we can't do that (the database needs something to populate existing rows).
  Please select a fix:
   1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
   2) Quit, and let me add a default in models.py
  Select an option: 1
  Please enter the default value now, as valid Python
  The datetime and django.utils.timezone modules are available, so you can do e.g. timezone.now
  Type 'exit' to exit this prompt
  >>> 2
  
  $ python manage.py migrate
  ```

  - views.py : create() 함수 수정

    ```python
    def create(request):    
        if request.method == 'POST':
            # Binding 과정
            # 폼 인스턴스를 생성하고, 전달받은 데이터를 채운다.
            # 인스턴스에 데이터를 채워서, 유효성 검증을 진행한다. (그래서 변수에 담음)
            form = ArticleForm(request.POST)
            # embed()
            if form.is_valid():
                article = form.save(commit=False)
                article.user = request.user
                article.save()

            return redirect('articles:detail', article.pk)
        else:
            form = ArticleForm()

        # form으로 전달받는 형태가 2가지
        # 1. GET 요청 -> 비어있는 폼 전달
        # 2. 유효성 검증 실패 -> 에러 메세지를 포함한 채로 폼 전달
        context = {'form':form}
        return render(request,'articles/form.html', context)
    ```

#### Article 수정, 삭제시 조건체크 추가

- views.py

```python
@require_POST
def delete(request, article_pk):    
    if request.user.is_authenticated:#사용자가 로그인 되어 있는지
        article = get_object_or_404(Article,pk=article_pk) #삭제할 게시글
        if request.user == article.user: #로그인한 사용자와 게시글 작성자가 같은지
            article.delete()
        else:
            return redirect('articles:detail',article.pk)

    return redirect('articles:index')
    
```

- detail.html 수정
  - {% if request.user == article.user %} 추가

```html
...
{% if request.user == article.user %}
<a href="{% url 'articles:update' article.pk %}">[UPDATE]<a>
<form action="{% url 'articles:delete' article.pk %}" method="POST">
{% csrf_token %}<button type="submit" >[DELETE]</button>
</form>
{% endif %}
```

#### User - Comment