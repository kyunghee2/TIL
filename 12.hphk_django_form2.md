## User - Article & Comment

- User 클래스 가져오는법

  - `settings.AUTH_USER_MODEL`

    - return str (string )형태로 리턴됨

    - models.py에서 모델 정의할 때만 사용

      ```python
      from django.conf import settings
      settings.AUTH_USER_MODEL
      ```

      

  - `get_user_model()`

    - return class 형태로 리턴됨

    - models.py 제외한 모든곳에서 사용

      ```python
      from django.contrib.auth import get_user_model
      get_user_model()
      ```

- django 호출순서
  - app install > model
  - settings.py 파일에 INSTALLED_APPS=[] 정의된 순서대로 호출됨

#### User - Article

- articels > models.py :모델수정

  ```python
  from django.conf import settings
  
  class Article(models.Model):
      ...
      user = models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE)
  
  ```

  ```bash
  #/05_django/04_django_form (master)
  $ source ~/venv/Scripts/activate
  $ python manage.py makemigrations
  You are trying to add a non-nullable field 'user' to article without a default; we can't do that (the database needs something to populate existing rows).
  Please select a fix:
   1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
   2) Quit, and let me add a default in models.py
  Select an option: 1
  Please enter the default value now, as valid Python
  The datetime and django.utils.timezone modules are available, so you can do e.g. timezone.now
  Type 'exit' to exit this prompt
  >>> 2
  
  $ python manage.py migrate
  ```

  - views.py : create() 함수 수정

  ```python
    def create(request):    
        if request.method == 'POST':
            # Binding 과정
            # 폼 인스턴스를 생성하고, 전달받은 데이터를 채운다.
            # 인스턴스에 데이터를 채워서, 유효성 검증을 진행한다. (그래서 변수에 담음)
            form = ArticleForm(request.POST)
            # embed()
            if form.is_valid():
                article = form.save(commit=False)
                article.user = request.user
                article.save()

            return redirect('articles:detail', article.pk)
        else:
            form = ArticleForm()

        # form으로 전달받는 형태가 2가지
        # 1. GET 요청 -> 비어있는 폼 전달
        # 2. 유효성 검증 실패 -> 에러 메세지를 포함한 채로 폼 전달
        context = {'form':form}
        return render(request,'articles/form.html', context)
  ```

#### Article 수정, 삭제시 조건체크 추가

- views.py

```python
@require_POST
def delete(request, article_pk):    
    if request.user.is_authenticated:#사용자가 로그인 되어 있는지
        article = get_object_or_404(Article,pk=article_pk) #삭제할 게시글
        if request.user == article.user: #로그인한 사용자와 게시글 작성자가 같은지
            article.delete()
        else:
            return redirect('articles:detail',article.pk)

    return redirect('articles:index')
    
```

- detail.html 수정
  - {% if request.user == article.user %} 추가

```html
...
{% if request.user == article.user %}
<a href="{% url 'articles:update' article.pk %}">[UPDATE]<a>
<form action="{% url 'articles:delete' article.pk %}" method="POST">
{% csrf_token %}<button type="submit" >[DELETE]</button>
</form>
{% endif %}
```

#### User - Comment

- models.py 수정

  ```python
  class Comment(models.Model):
      article = models.ForeignKey(Article, on_delete=models.CASCADE)
      content = models.TextField()
      created_at = models.DateTimeField(auto_now_add=True)
      updated_at = models.DateTimeField(auto_now=True)
      user = models.ForeignKey(settings.AUTH_USER_MODEL,on_delete=models.CASCADE)
  
      #Model Level에서 메타데이터 옵션 설정
      #-> 정렬기능 사용
      class Meta:
          ordering = ['-pk',] 
  
      #객체 표현 방식
      def __str__(self):
          return self.content
  ```

  ```bash
#/05_django/04_django_form (master)
$ source ~/venv/Scripts/activate
$ python manage.py makemigrations
$ python manage.py migrate
  ```

#### Comment 작성, 삭제시 조건 체크
- views.py : comments_create() 수정

  ```python
  @require_POST
  def comments_create(requset, article_pk):
      #article = get_object_or_404(Article, pk =article_pk)    
      comment_form = CommentForm(requset.POST)
      if comment_form.is_valid():
          comment  = comment_form.save(commit=False)
          comment.user = requset.user
          #comment.article = article    #방법1    
          comment.article_id = article_pk #방법2
          comment.save()
  
          return redirect('articles:detail',article_pk)
  
  @require_POST
  def comments_delete(requset, article_pk,comment_pk):
      if requset.user.is_authenticated: #로그인여부확인
          comment = get_object_or_404(Comment,pk=comment_pk)
          if requset.user == comment.user: #로그인한 사용자와 댓글 작성자가 같을 경우
              comment.delete()
      return redirect('articles:detail',article_pk)
  ```

- detail.html 수정

  ```html
  {% extends 'base.html' %}
  {% load bootstrap4 %}
  {% block body %}
    <br>
    <h1>DETAIL</h1>
    <hr>
  
  <p>글 번호 : {{ article.pk }}</p>
  <p>글 제목 : {{ article.title }}</p>
  <p>글 내용 : {{ article.content }}</p>
  <p>생성 시각 : {{ article.created_at }}</p>
  <p>수정 시각 : {{ article.updated_at }}</p>
  <hr>
  <a href="{% url 'articles:index' %}">[BACK]</a>
  {% if request.user == article.user %}
  <a href="{% url 'articles:update' article.pk %}">[UPDATE]<a>
  <form action="{% url 'articles:delete' article.pk %}" method="POST">
  {% csrf_token %}<button type="submit" >[DELETE]</button>
  </form>
  {% endif %}
  <hr>
  <br>
  {% if user.is_authenticated %}
  <form action="{% url 'articles:comments_create' article.pk %}" method="POST">
    <!-- POST 요청할 때 반드시 설정 -->
    {% csrf_token %}
    {% bootstrap_form comment_form layout='inline' %}
    <div class="text-center">
      {% buttons submit='댓글작성' %}{% endbuttons %}
    </div>
  </form>
  {% else%}
  <a href="{% url 'accounts:login' %}">[댓글을 작성하려면 로그인 해주세요]</a>
  {% endif %}
  <hr>
  <p><b>댓글목록({{comments|length}}개)</b></p>
  {% for comment in comments %}
  <p>[{{forloop.revcounter}}번 댓글] {{comment.content}} <small>({{comment.created_at}})</small>
  {% if comment.user == request.user %}
  <form action="{% url 'articles:comments_delete' article.pk comment.pk %}" method="POST">
  {% csrf_token %}<button type="submit" >댓글삭제</button></form>
  {% endif %}
  </p>
  {% endfor %}
  {% endblock %}
  ```

  